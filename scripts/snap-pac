#!/usr/bin/env python
# Copyright (C) 2021 Wes Barnett

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
"""
Script for taking pre/post snapshots; run from pacman hooks.
"""

from argparse import ArgumentParser
from configparser import ConfigParser
import logging
import os
import sys

logging.basicConfig(format="%(message)s", level=logging.INFO)


def create_snapper_cmd(args, config, section):
    chroot = os.stat("/") != os.stat("/proc/1/root/.")
    snapper_cmd = ["snapper"]
    if chroot:
        snapper_cmd.append("--no-dbus")
    snapper_cmd.append(f"--config {section} create")
    snapper_cmd.append(f"--type {args.preorpost}")
    snapper_cmd.append(f"--cleanup-algorithm {config.get(section, 'cleanup_algorithm')}")
    snapper_cmd.append("--print-number")
    desc_limit = config.getint(section, "desc_limit")
    if args.preorpost == "pre":
        snapper_cmd.append(f"--description {config.get(section, 'pre_description')[:desc_limit]}")
    else:
        snapper_cmd.append(f"--description {config.get(section, 'post_description')[:desc_limit]}")
    return snapper_cmd


def do_snapshot(preorpost, cmd, prefile):
    if preorpost == "pre":
        return do_pre_snapshot(cmd, prefile)
    else:
        return do_post_snapshot(cmd, prefile)


def do_pre_snapshot(cmd, prefile):
    """Run snapper command, write snapshot number to file."""
    num = os.popen(" ".join(cmd)).read().rstrip("\n")
    with open(prefile, "w") as f:
        f.write(num)
    return num


def do_post_snapshot(cmd, prefile):
    """Read pre snapshot number from file, run snapper, delete prefile."""
    with open(prefile, "r") as f:
        pre_number = f.read().rstrip("\n")
        cmd.append(f"--pre-number {pre_number}")
    os.remove(prefile)
    return os.popen(" ".join(cmd)).read().rstrip("\n")


def get_snapper_configs(conf_file):
    """Get the snapper configurations."""
    with open(conf_file, "r") as f:
        for line in f:
            if line.startswith("SNAPPER_CONFIGS"):
                line = line.rstrip("\n").rstrip("\"").split("=")
                return line[1].lstrip("\"").split()


def setup_config_parser(ini_file):
    """Set up defaults for snap-pac configuration."""
    parent_cmd = os.popen(f"ps -p {os.getppid()} -o args=").read().strip()
    packages = " ".join([line.rstrip("\n") for line in sys.stdin])

    config = ConfigParser()
    config["DEFAULT"] = {
        "snapshot": False,
        "cleanup_algorithm": "number",
        "pre_description": "".join(["\"", parent_cmd, "\""]),
        "post_description":  "".join(["\"", packages, "\""]),
        "desc_limit": 72
    }
    config["root"] = {
        "snapshot": True
    }
    config.read(ini_file)
    return config


def main(snap_pac_ini, snapper_conf_file, args):
    config = setup_config_parser(snap_pac_ini)
    snapper_configs = get_snapper_configs(snapper_conf_file)

    if os.getenv("SNAP_PAC_SKIP", "n") in ["y", "Y", "yes", "Yes", "YES"]:
        return

    for c in snapper_configs:

        if c not in config:
            config.add_section(c)

        logging.debug(f"{c = }")
        if config.getboolean(c, "snapshot"):
            prefile = f"/tmp/snap-pac-pre_{c}"
            logging.debug(f"{prefile = }")
            snapper_cmd = create_snapper_cmd(args, config, c)
            logging.debug(f"{snapper_cmd = }")
            num = do_snapshot(args.preorpost, snapper_cmd, prefile)
            logging.info(f"==> {c}: {num}")


if __name__ == "__main__":

    snap_pac_ini = "/etc/snap-pac.ini"
    logging.debug(f"{snap_pac_ini = }")
    snapper_conf_file = "/etc/conf.d/snapper"
    logging.debug(f"{snapper_conf_file = }")

    parser = ArgumentParser()
    parser.add_argument(dest="preorpost")
    args = parser.parse_args()

    if args.preorpost not in ["pre", "post"]:
        raise ValueError("preorpost must be 'pre' or 'post'")

    main(snap_pac_ini, snapper_conf_file, args)
